<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teleza Reeves — GEMS Quiz</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#07060a;
      --bg-card:#121017;
      --fg:#ffffff;
      --muted:#c9c4d4;

      --brand:#a78bfa;       /* lavender */
      --brand-soft:#f9a8d4;  /* blush */
      --brand-ivory:#f5f2ff;
      --border-soft: rgba(255,255,255,0.18);

      --sapphire:#2bb3ff;
      --ruby:#ff3b3b;
      --pearl:#ffd7f2;
      --emerald:#30d985;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0; padding:0;
      background: radial-gradient(circle at top, #1a1224 0, var(--bg) 60%);
      color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    body{ min-height:100vh; display:flex; flex-direction:column; }

    header{
      padding:20px 16px 14px;
      border-bottom:1px solid rgba(255,255,255,0.12);
      text-align:center;
      position:sticky;
      top:0;
      z-index:5;
      backdrop-filter: blur(12px);
      background: linear-gradient(to bottom, rgba(7,6,10,0.95), rgba(7,6,10,0.85));
    }
    .brand{
      font-weight:900;
      font-size:14px;
      letter-spacing:1.4px;
      text-transform:uppercase;
      background: linear-gradient(90deg, var(--brand), var(--brand-soft));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    h1{ margin:4px 0 4px; font-size: clamp(22px, 5vw, 30px); }
    .sub{ color:var(--muted); font-size:13px; }

    .wrap{
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 60px;
      width: 100%;
    }

    .card{
      background: var(--bg-card);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 16px 14px;
      margin-bottom: 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.45);
    }
    .card--glow{
      border: 1px solid rgba(167,139,250,0.55);
      box-shadow: 0 0 22px rgba(249,168,212,0.12);
    }

    .meta{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .quiz-layout{
      display:grid;
      grid-template-columns: minmax(0, 1fr);
      gap:12px;
    }
    @media (min-width: 800px){
      .quiz-layout{
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      }
    }

    .progress-shell{ margin:10px 0 14px; font-size:12px; color:var(--muted); }
    .progress-label-row{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .progress-bar{ width:100%; height:7px; border-radius:999px; background: rgba(255,255,255,0.07); overflow:hidden; }
    .progress-fill{
      height:100%;
      width:0;
      border-radius:999px;
      background: linear-gradient(90deg, var(--brand), var(--brand-soft));
      transition: width 0.18s ease-out;
    }

    .q{ font-weight:700; margin-bottom:10px; font-size:15px; }

    .answers{ display:grid; gap:8px; }
    .answer{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(0,0,0,0.4));
      cursor:pointer;
      font-size:14px;
      transition: border-color 0.15s ease, background 0.15s ease, transform 0.08s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .answer input{ accent-color: var(--brand); transform: scale(1.1); }
    .answer:hover{ border-color: rgba(249,168,212,0.85); }
    .answer.selected{
      border-color: rgba(167,139,250,0.95);
      background: radial-gradient(circle at left, rgba(167,139,250,0.18), rgba(0,0,0,0.6));
      transform: translateY(-1px);
    }

    .buttons{ display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 4px; }
    button{
      border-radius:999px;
      border:none;
      padding:9px 18px;
      font-weight:800;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      cursor:pointer;
    }
    .btn-primary{ background: linear-gradient(90deg, var(--brand), var(--brand-soft)); color:#0f0b17; }
    .btn-secondary{ background:transparent; color:var(--fg); border:1px solid rgba(255,255,255,0.3); }

    .result{
      padding:14px 14px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.16);
      background: radial-gradient(circle at top left, rgba(167,139,250,0.14), #0b0a10);
      display:none;
    }
    .result-title{ font-size:18px; font-weight:800; margin-bottom:4px; }

    .pill{
      display:inline-flex; align-items:center;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.24);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:6px;
      gap:6px;
    }
    .dot{ width:10px; height:10px; border-radius:999px; background: var(--brand); }

    .section-title{ margin-top:10px; font-size:14px; font-weight:800; }
    .bars{ margin-top:8px; display:grid; gap:8px; }
    .bar-row{ display:flex; align-items:center; gap:8px; font-size:13px; }
    .bar-label{ width:80px; text-transform:uppercase; font-weight:700; font-size:11px; }
    .bar-shell{ flex:1; height:14px; border-radius:999px; background: rgba(255,255,255,0.06); overflow:hidden; }
    .bar-fill{ height:100%; width:0; border-radius:999px; }
    .bar-val{ width:42px; text-align:right; font-weight:700; font-size:12px; }

    .bullets{ margin:4px 0 0; padding-left:18px; font-size:13px; color:var(--muted); }
    .bullets li{ margin-bottom:3px; }

    .profile-tools{ margin-top:10px; display:none; }
    .profile-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px; }
    .profile-tools input[type="text"]{
      background:#0b0b12;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.2);
      padding:8px 9px;
      font-size:13px;
      color:var(--fg);
      min-width:180px;
    }
    .profile-tools input[type="file"]{ font-size:12px; color:var(--muted); }

    .preview{
      margin-top:10px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,0.24);
      background:#05050a;
      padding:8px;
      text-align:center;
    }
    .preview img{ max-width:100%; border-radius:14px; display:block; margin:0 auto; }

    .footer{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      padding:10px 16px 18px;
      margin-top:auto;
      opacity:0.85;
    }
    .badge-legal{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.2);
      padding:2px 6px;
      display:inline-block;
      margin-bottom:4px;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">Teleza Reeves</div>
  <h1>GEMS Personality Quiz</h1>
  <div class="sub">Discover your dominant money-making personality: Sapphire • Ruby • Pearl • Emerald</div>
</header>

<div class="wrap">
  <div class="card card--glow">
    <div class="meta">
      This quiz is created by Teleza Reeves — to help you understand how you naturally move in money,
      business, and community. Choose the answer that sounds most like you <b>most of the time</b>.
    </div>
  </div>

  <div class="quiz-layout">
    <div>
      <div class="card">
        <div class="progress-shell">
          <div class="progress-label-row">
            <span id="progressText">Question 1 of 16</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <div id="questionContainer"></div>

        <div class="buttons">
          <button class="btn-secondary" id="prevBtn" type="button">Back</button>
          <button class="btn-primary" id="nextBtn" type="button">Next</button>
        </div>
      </div>
    </div>

    <div>
      <div id="resultPanel" class="result"></div>

      <div class="profile-tools" id="profileTools">
        <div class="card">
          <div class="q">Generate your share card</div>
          <div class="meta" style="margin-bottom:6px;">
            Perfect for Instagram / TikTok — 1080×1350 portrait. Add your name + optional photo, then download as PNG.
          </div>
          <div class="profile-row">
            <input type="text" id="displayName" placeholder="Your name (optional)">
            <input type="text" id="brandTag" placeholder="@handle or tagline (optional)">
            <input type="file" id="photoInput" accept="image/*">
            <button class="btn-primary" id="makeCard" type="button">Generate My Share Card</button>
          </div>
          <div class="profile-row">
            <button class="btn-secondary" id="downloadCard" type="button" style="display:none;">Download PNG</button>
          </div>
          <div class="preview" id="cardPreview" style="display:none;">
            <img id="cardImg" alt="Share card preview">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <span class="badge-legal">For personal insight only</span><br>
    Not medical, legal, or financial advice. © Teleza Reeves
  </div>
</div>

<script>
/********************
 * CONFIG (CONTENT) *
 ********************/
const APP_CONFIG = {
  brand: {
    primary: getComputedStyle(document.documentElement).getPropertyValue("--brand").trim(),
    primarySoft: getComputedStyle(document.documentElement).getPropertyValue("--brand-soft").trim(),
    background: getComputedStyle(document.documentElement).getPropertyValue("--bg").trim(),
    fontFamily: "system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"
  },
  gems: {
    sapphire: {
      label: "Sapphire",
      colorVar: "--sapphire",
      description: "People-oriented • Active • Magnetic. You bring the fun, the story, and the vibe.",
      benefits: [
        "You attract people and attention effortlessly.",
        "You make experiences feel fun and memorable.",
        "You keep energy high in teams and communities.",
        "You’re a natural storyteller and promoter."
      ],
      challenges: [
        "Finishing what you start when excitement wears off.",
        "Over-committing to too many ideas at once.",
        "Avoiding boring but necessary routines."
      ],
      tips: [
        "Use timers and short sprints to get through boring tasks.",
        "Batch content on high-energy days; schedule it to post later.",
        "Keep a simple weekly scoreboard for money, content, and follow-ups."
      ],
      howToWin: [
        "Lead from the front with energy — host lives, events, and launches.",
        "Build a simple content ecosystem around your face, story, and lifestyle.",
        "Collaborate with structured teammates so your ideas become assets."
      ]
    },
    ruby: {
      label: "Ruby",
      colorVar: "--ruby",
      description: "Task-oriented • Active • Competitive. You’re here to win, build, and scale.",
      benefits: [
        "You move fast and hate wasting time.",
        "You’re naturally driven by goals and milestones.",
        "You’re decisive when others hesitate."
      ],
      challenges: [
        "Impatience with slower or more sensitive people.",
        "Pushing so hard you ignore your own needs.",
        "Getting bored after hitting a goal."
      ],
      tips: [
        "Use clear scoreboards for income, sales, and follow-ups.",
        "Schedule rest like it’s part of the strategy.",
        "Focus on a few key levers instead of scattered efforts."
      ],
      howToWin: [
        "Set bold but clear goals with real timelines.",
        "Design weekly power hours for revenue-moving actions.",
        "Build assets (scripts, funnels, templates) so your ambition scales."
      ]
    },
    pearl: {
      label: "Pearl",
      colorVar: "--pearl",
      description: "People-oriented • Calm • Heart-led. You care deeply about impact, safety, and soul.",
      benefits: [
        "You make people feel safe, seen, and supported.",
        "You’re great at customer care and retention.",
        "You listen deeply and remember details."
      ],
      challenges: [
        "Avoiding conflict when boundaries are needed.",
        "Under-charging because you just want to help.",
        "Over-giving and burning out silently."
      ],
      tips: [
        "Write down prices and boundaries so you don’t negotiate against yourself.",
        "Use scripts to invite people to your offers confidently.",
        "Protect your energy with office hours and containers."
      ],
      howToWin: [
        "Position yourself as the safe, trusted guide in your space.",
        "Design transformation-focused offers, not just transactional ones.",
        "Lead with compassion — and protect your capacity like a CEO."
      ]
    },
    emerald: {
      label: "Emerald",
      colorVar: "--emerald",
      description: "Task-oriented • Calm • Strategic. You see patterns, systems, and risk clearly.",
      benefits: [
        "You think in processes, not just moments.",
        "You notice details others overlook.",
        "You can turn a messy idea into a clear plan."
      ],
      challenges: [
        "Over-analyzing and delaying action.",
        "Waiting for perfection before moving.",
        "Under-sharing your genius because it feels obvious."
      ],
      tips: [
        "Use 70% clarity as ‘enough to move’ instead of waiting for 100%.",
        "Turn your frameworks into templates and products.",
        "Share your behind-the-scenes thinking — people will call it genius."
      ],
      howToWin: [
        "Own the back-end: operations, finances, tech, and quality control.",
        "Create signature frameworks that become part of your brand language.",
        "Document once so it can be reused many times."
      ]
    }
  },
  quiz: {
    title: "Teleza Reeves — GEMS Quiz",
    questions: [
      { text: "What gets you excited to start a new project?", options: {
        sapphire: "It sounds fun and I get to involve people.",
        ruby: "A clear challenge, competition, or prize to win.",
        pearl: "It helps or uplifts people I care about.",
        emerald: "There’s a plan, data, and a well-defined process."
      }},
      { text: "When making a decision, I usually…", options: {
        sapphire: "Go with my gut and keep the vibe positive.",
        ruby: "Choose quickly and move.",
        pearl: "Ask who will be affected and consider feelings.",
        emerald: "Weigh pros/cons and research first."
      }},
      { text: "At a social or business event, you can find me…", options: {
        sapphire: "Chatting with everyone and starting conversations.",
        ruby: "Networking with a purpose—making moves and connections.",
        pearl: "Checking in on people and making them comfortable.",
        emerald: "Having a thoughtful 1:1 conversation off to the side."
      }},
      { text: "My ideal work style looks like…", options: {
        sapphire: "Flexible, creative, and people-first.",
        ruby: "Fast paced, goal-driven, and results-focused.",
        pearl: "Supportive, collaborative, and service-oriented.",
        emerald: "Organized, detailed, and system-driven."
      }},
      { text: "Deadlines feel…", options: {
        sapphire: "Motivating if the project is exciting.",
        ruby: "Essential—it’s how we win.",
        pearl: "Manageable when the team is aligned.",
        emerald: "Comforting—structure keeps quality high."
      }},
      { text: "When conflict shows up, I tend to…", options: {
        sapphire: "Lighten the mood and keep it moving.",
        ruby: "Address it head-on and resolve it fast.",
        pearl: "Seek harmony and listen to everyone.",
        emerald: "Collect facts and clarify misunderstandings."
      }},
      { text: "If a plan changes last-minute…", options: {
        sapphire: "No stress—let’s improvise!",
        ruby: "Fine—what’s the fastest path to the goal now?",
        pearl: "I check in to make sure everyone’s okay.",
        emerald: "I want the details and updated timeline."
      }},
      { text: "Your desk or digital life is…", options: {
        sapphire: "Organized chaos—creative piles.",
        ruby: "Minimal—whatever helps me move fastest.",
        pearl: "Personal—photos, notes, reminders for people.",
        emerald: "Neat—folders, labels, templates."
      }},
      { text: "Feedback you love to hear:", options: {
        sapphire: "“You made this so fun.”",
        ruby: "“You crushed that goal.”",
        pearl: "“You made me feel seen.”",
        emerald: "“Your system was flawless.”"
      }},
      { text: "When learning something new…", options: {
        sapphire: "I jump in and figure it out as I go.",
        ruby: "I want the fastest path to mastery.",
        pearl: "I learn best with a buddy, coach, or mentor.",
        emerald: "I read the instructions and build a checklist."
      }},
      { text: "Your content or communication style naturally leans…", options: {
        sapphire: "Entertaining, high-energy, story-driven.",
        ruby: "Results and proof—before/after, wins, receipts.",
        pearl: "Encouraging, supportive, and heart-centered.",
        emerald: "Breakdowns, how-to’s, and data."
      }},
      { text: "Biggest demotivator for you is…", options: {
        sapphire: "Boredom and rigid rules.",
        ruby: "Feeling stalled or losing momentum.",
        pearl: "Tension and people getting hurt.",
        emerald: "Vague goals and sloppy execution."
      }},
      { text: "If you ran a team, your #1 priority would be…", options: {
        sapphire: "Keep morale and creativity high.",
        ruby: "Hit ambitious, measurable targets.",
        pearl: "Care for people and grow them.",
        emerald: "Build scalable, clear systems."
      }},
      { text: "Which compliment lands the hardest?", options: {
        sapphire: "“You light up the room.”",
        ruby: "“You’re unstoppable.”",
        pearl: "“You’re so thoughtful.”",
        emerald: "“You’re meticulous.”"
      }},
      { text: "Your planning tool of choice:", options: {
        sapphire: "Vision board / brainstorm space.",
        ruby: "Scoreboard / KPI tracker.",
        pearl: "Shared calendar / check-ins.",
        emerald: "Project management with SOPs."
      }},
      { text: "When you buy, you value…", options: {
        sapphire: "Experience and community.",
        ruby: "ROI and speed.",
        pearl: "Mission and trust.",
        emerald: "Specs and reliability."
      }}
    ]
  }
};

/****************
 * APP (LOGIC)  *
 ****************/
const questions = APP_CONFIG.quiz.questions;
const totalQuestions = questions.length; // MUST be 16

const questionContainer = document.getElementById("questionContainer");
const progressText = document.getElementById("progressText");
const progressPercent = document.getElementById("progressPercent");
const progressFill = document.getElementById("progressFill");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const resultPanel = document.getElementById("resultPanel");
const profileTools = document.getElementById("profileTools");

let currentIndex = 0;
let answers = {}; // { index: "sapphire"|"ruby"|"pearl"|"emerald" }

function getGemColor(key){
  const cfg = APP_CONFIG.gems[key];
  if (!cfg) return APP_CONFIG.brand.primary;
  const v = getComputedStyle(document.documentElement).getPropertyValue(cfg.colorVar).trim();
  return v || APP_CONFIG.brand.primary;
}

function updateProgress(){
  const answeredCount = Object.keys(answers).length;
  const pct = Math.round((answeredCount / totalQuestions) * 100);
  progressText.textContent = `Question ${currentIndex + 1} of ${totalQuestions}`;
  progressPercent.textContent = `${pct}%`;
  progressFill.style.width = `${pct}%`;
}

function renderQuestion(idx){
  const q = questions[idx];
  if (!q) return;

  questionContainer.innerHTML = "";

  const card = document.createElement("div");
  card.className = "card";

  const qEl = document.createElement("div");
  qEl.className = "q";
  qEl.textContent = `Q${idx + 1}. ${q.text}`;
  card.appendChild(qEl);

  const answersWrap = document.createElement("div");
  answersWrap.className = "answers";

  ["sapphire","ruby","pearl","emerald"].forEach(key => {
    const text = q.options[key];
    if (!text) return;

    const label = document.createElement("label");
    label.className = "answer";
    if (answers[idx] === key) label.classList.add("selected");

    const input = document.createElement("input");
    input.type = "radio";
    input.name = `q${idx}`;
    input.value = key;
    input.checked = (answers[idx] === key);

    const span = document.createElement("span");
    span.textContent = text;

    label.appendChild(input);
    label.appendChild(span);

    label.addEventListener("click", () => {
      answers[idx] = key;
      answersWrap.querySelectorAll(".answer").forEach(a => a.classList.remove("selected"));
      label.classList.add("selected");
      updateProgress();
    });

    answersWrap.appendChild(label);
  });

  card.appendChild(answersWrap);
  questionContainer.appendChild(card);

  prevBtn.disabled = idx === 0;
  nextBtn.textContent = (idx === totalQuestions - 1) ? "See My Results" : "Next";
  updateProgress();
}

function computeResults(){
  const counts = { sapphire:0, ruby:0, pearl:0, emerald:0 };
  for (let i=0;i<totalQuestions;i++){
    const val = answers[i];
    if (val && counts.hasOwnProperty(val)) counts[val]++;
  }
  const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1;
  const pct = {};
  Object.keys(counts).forEach(k => pct[k] = Math.round((counts[k] / total) * 100));
  const ranking = Object.entries(pct).sort((a,b)=>b[1]-a[1]);
  const topKey = ranking[0][0];
  return { counts, pct, topKey, ranking };
}

function renderResults(){
  const { pct, topKey } = computeResults();
  const gem = APP_CONFIG.gems[topKey];

  resultPanel.style.display = "block";

  const barsHTML = ["sapphire","ruby","pearl","emerald"].map(k => {
    const label = APP_CONFIG.gems[k].label;
    const value = pct[k] || 0;
    const c = getGemColor(k);
    return `
      <div class="bar-row">
        <div class="bar-label">${label}</div>
        <div class="bar-shell">
          <div class="bar-fill" style="width:${value}%; background:linear-gradient(90deg, ${c}, rgba(255,255,255,0.25));"></div>
        </div>
        <div class="bar-val">${value}%</div>
      </div>
    `;
  }).join("");

  const benefitsList = gem.benefits.map(x => `<li>${x}</li>`).join("");
  const challengesList = gem.challenges.map(x => `<li>${x}</li>`).join("");
  const tipsList = gem.tips.map(x => `<li>${x}</li>`).join("");
  const howToWinList = gem.howToWin.map(x => `<li>${x}</li>`).join("");

  resultPanel.innerHTML = `
    <div class="pill">
      <span class="dot" style="background:${getGemColor(topKey)};"></span>
      TOP GEM: ${gem.label.toUpperCase()}
    </div>
    <div class="result-title">${gem.label} — ${gem.description}</div>

    <div class="section-title">Your GEMS Mix</div>
    <div class="bars">${barsHTML}</div>

    <div class="section-title">Your Natural Benefits</div>
    <ul class="bullets">${benefitsList}</ul>

    <div class="section-title">Growth Edges & Challenges</div>
    <ul class="bullets">${challengesList}</ul>

    <div class="section-title">Practical Tips</div>
    <ul class="bullets">${tipsList}</ul>

    <div class="section-title">How to Win as a ${gem.label}</div>
    <ul class="bullets">${howToWinList}</ul>

    <div class="buttons" style="margin-top:10px;">
      <button class="btn-primary" type="button" id="showShareCardBtn">Generate My Share Card</button>
    </div>
  `;

  document.getElementById("showShareCardBtn").addEventListener("click", () => {
    profileTools.style.display = "block";
    profileTools.scrollIntoView({ behavior: "smooth" });
  });
}

prevBtn.addEventListener("click", () => {
  if (currentIndex > 0){
    currentIndex--;
    renderQuestion(currentIndex);
  }
});

nextBtn.addEventListener("click", () => {
  if (!answers[currentIndex]){
    alert("Please select an answer for this question first.");
    return;
  }
  if (currentIndex < totalQuestions - 1){
    currentIndex++;
    renderQuestion(currentIndex);
  } else {
    if (Object.keys(answers).length < totalQuestions){
      alert("Please answer all questions to see your results.");
      return;
    }
    renderResults();
    resultPanel.scrollIntoView({ behavior: "smooth" });
  }
});

// Initial render
renderQuestion(currentIndex);

/*******************************
 * SHARE CARD (PNG GENERATOR)  *
 *******************************/
let loadedPhoto = null;
let loadedPhotoReady = false;

const photoInput = document.getElementById("photoInput");
const makeCardBtn = document.getElementById("makeCard");
const downloadBtn = document.getElementById("downloadCard");
const cardPreview = document.getElementById("cardPreview");
const cardImg = document.getElementById("cardImg");

photoInput.addEventListener("change", async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file){
    loadedPhoto = null;
    loadedPhotoReady = false;
    return;
  }

  loadedPhotoReady = false;
  const url = URL.createObjectURL(file);

  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = url;

  try{
    await img.decode();
    loadedPhoto = img;
    loadedPhotoReady = true;
  } catch(err){
    loadedPhoto = null;
    loadedPhotoReady = false;
    console.error("Photo decode failed:", err);
  } finally{
    URL.revokeObjectURL(url);
  }
});

function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = String(text || "").split(" ");
  let line = "";
  const lines = [];

  for (let n=0;n<words.length;n++){
    const test = line + words[n] + " ";
    const w = ctx.measureText(test).width;
    if (w > maxWidth && n > 0){
      lines.push(line.trim());
      line = words[n] + " ";
    } else {
      line = test;
    }
  }
  if (line.trim()) lines.push(line.trim());

  lines.forEach((ln,i)=> ctx.fillText(ln, x, y + i*lineHeight));
  return y + (lines.length * lineHeight);
}

function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function textHeight(ctx, fallback){
  const m = ctx.measureText("Mg");
  const h = (m.actualBoundingBoxAscent || 0) + (m.actualBoundingBoxDescent || 0);
  return h || fallback;
}

/**
 * Draw bottom stack safely:
 * rule (lowest) -> footer label -> gap -> tag -> name (highest)
 * Uses real font metrics so it never overlaps.
 */
function drawBottomStack(ctx, {
  CX, CW, H,
  padLeft = 40,
  padRight = 40,
  padBottom = 36,
  gap = 14,
  footerText = "TELEZA REEVES • GEMS PERSONALITY",
  nameVal = "",
  tagVal = ""
}){
  const leftX = CX + padLeft;
  const rightX = CX + CW - padRight;

  // 1) Rule near bottom
  const ruleY = H - padBottom;

  ctx.strokeStyle = APP_CONFIG.brand.primary;
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(leftX, ruleY);
  ctx.lineTo(rightX, ruleY);
  ctx.stroke();

  // 2) Footer label above rule
  ctx.font = "800 22px " + APP_CONFIG.brand.fontFamily;
  ctx.fillStyle = APP_CONFIG.brand.primary;
  const footerH = textHeight(ctx, 28);
  const footerY = ruleY - 10; // baseline
  ctx.fillText(footerText, leftX + 8, footerY);

  // 3) Stack identity above footer label
  let y = footerY - footerH - gap;

  // Tag
  if (tagVal){
    ctx.font = "600 24px " + APP_CONFIG.brand.fontFamily;
    ctx.fillStyle = "#d0d0d0";
    ctx.fillText(tagVal, leftX, y);
    y -= (textHeight(ctx, 32) + 10);
  }

  // Name
  if (nameVal){
    ctx.font = "800 30px " + APP_CONFIG.brand.fontFamily;
    ctx.fillStyle = "#ffffff";
    ctx.fillText(nameVal, leftX, y);
    y -= (textHeight(ctx, 40) + 10);
  }

  return { ruleY, footerY };
}

function drawShareCard(data, photo){
  const { pct, topKey } = data;
  const gem = APP_CONFIG.gems[topKey];

  const W = 1080;
  const H = 1350;
  const pad = 60;

  const canvas = document.createElement("canvas");
  canvas.width = W;
  canvas.height = H;

  const ctx = canvas.getContext("2d");
  if (!ctx) return canvas;

  // Background
  const bgGrad = ctx.createLinearGradient(0, 0, W, H);
  bgGrad.addColorStop(0, "#1a1224");
  bgGrad.addColorStop(1, "#07060a");
  ctx.fillStyle = bgGrad;
  ctx.fillRect(0, 0, W, H);

  const CX = pad, CY = pad, CW = W - 2*pad, CH = H - 2*pad;

  // Inner card
  ctx.fillStyle = "rgba(0,0,0,0.68)";
  ctx.strokeStyle = "rgba(255,255,255,0.22)";
  ctx.lineWidth = 2;
  roundRect(ctx, CX, CY, CW, CH, 34);
  ctx.fill();
  ctx.stroke();

  // Header text
  ctx.fillStyle = "#ffffff";
  ctx.font = "900 52px " + APP_CONFIG.brand.fontFamily;
  ctx.fillText("TELEZA REEVES", CX + 40, CY + 85);

  ctx.font = "700 34px " + APP_CONFIG.brand.fontFamily;
  ctx.fillStyle = APP_CONFIG.brand.primarySoft;
  ctx.fillText(("TOP GEM: " + gem.label).toUpperCase(), CX + 40, CY + 135);

  // Photo circle
  const P = 210;
  const pX = CX + CW - P - 46;
  const pY = CY + 46;

  ctx.save();
  ctx.beginPath();
  ctx.arc(pX + P/2, pY + P/2, P/2, 0, Math.PI * 2);
  ctx.closePath();
  ctx.clip();

  ctx.fillStyle = "#222";
  ctx.fillRect(pX, pY, P, P);

  if (photo){
    const ar = photo.width / photo.height;
    let sx=0, sy=0, sw=photo.width, sh=photo.height;
    if (ar > 1){
      sw = photo.height;
      sx = (photo.width - sw)/2;
    } else {
      sh = photo.width;
      sy = (photo.height - sh)/2;
    }
    ctx.drawImage(photo, sx, sy, sw, sh, pX, pY, P, P);
  }
  ctx.restore();

  ctx.strokeStyle = "rgba(255,255,255,0.35)";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.arc(pX + P/2, pY + P/2, P/2, 0, Math.PI * 2);
  ctx.stroke();

  // Mix bars
  let y = CY + 225;
  ctx.fillStyle = "#ffffff";
  ctx.font = "800 32px " + APP_CONFIG.brand.fontFamily;
  ctx.fillText("YOUR GEMS MIX", CX + 40, y);

  const keys = ["sapphire","ruby","pearl","emerald"];
  const startX = CX + 40;
  const barX = startX + 160;
  const barH = 24;

  const safeRight = pX - 30;
  const barW = Math.max(220, safeRight - barX);

  y += 26;

  keys.forEach((key) => {
    const lab = APP_CONFIG.gems[key].label;
    const value = pct[key] || 0;
    const gemColor = getGemColor(key);

    y += 50;

    ctx.font = "600 24px " + APP_CONFIG.brand.fontFamily;
    ctx.fillStyle = "#e0e0e0";
    ctx.fillText(lab, startX, y);

    ctx.fillStyle = "rgba(255,255,255,0.08)";
    roundRect(ctx, barX, y - 22, barW, barH, 12);
    ctx.fill();

    const w = Math.max(6, Math.round((barW * value) / 100));
    const fillGrad = ctx.createLinearGradient(barX, y - 22, barX + w, y - 22);
    fillGrad.addColorStop(0, gemColor);
    fillGrad.addColorStop(1, "rgba(255,255,255,0.35)");
    ctx.fillStyle = fillGrad;
    roundRect(ctx, barX, y - 22, w, barH, 12);
    ctx.fill();

    ctx.font = "700 22px " + APP_CONFIG.brand.fontFamily;
    ctx.fillStyle = "#ffffff";
    ctx.fillText(value + "%", barX + barW + 16, y - 2);
  });

  // How to win
  y += 70;
  ctx.font = "800 30px " + APP_CONFIG.brand.fontFamily;
  ctx.fillStyle = "#ffffff";
  ctx.fillText("HOW TO WIN AS A " + gem.label.toUpperCase(), CX + 40, y);

  y += 16;
  ctx.font = "500 22px " + APP_CONFIG.brand.fontFamily;
  ctx.fillStyle = "#dcdcdc";

  // Use up to 5 tips so the card feels fuller
  const tips = (gem.howToWin || []).slice(0, 5);
  let tipY = y + 18;
  tips.forEach((t) => {
    tipY = wrapText(ctx, "• " + t, CX + 40, tipY, CW - 80, 30) + 8;
  });

  // Bottom stack (bulletproof)
  const nameVal = (document.getElementById("displayName").value || "").trim();
  const tagVal  = (document.getElementById("brandTag").value || "").trim();

  drawBottomStack(ctx, {
    CX, CW, H,
    padLeft: 40,
    padRight: 40,
    padBottom: 36,   // tweak: 30–44 if you want
    gap: 14,
    footerText: "TELEZA REEVES • GEMS PERSONALITY",
    nameVal,
    tagVal
  });

  return canvas;
}

makeCardBtn.addEventListener("click", async () => {
  if (Object.keys(answers).length < totalQuestions){
    alert("Please finish the quiz first so your card shows the right result.");
    return;
  }

  if (photoInput.files && photoInput.files[0] && !loadedPhotoReady){
    alert("Your photo is still loading—tap Generate again in 1 second.");
    return;
  }

  const { pct, topKey } = computeResults();
  const canvas = drawShareCard({ pct, topKey }, loadedPhotoReady ? loadedPhoto : null);
  const url = canvas.toDataURL("image/png");

  cardImg.src = url;
  cardPreview.style.display = "block";
  downloadBtn.style.display = "inline-block";

  downloadBtn.onclick = () => {
    const a = document.createElement("a");
    a.href = url;
    a.download = "teleza-reeves-gems-card.png";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };
});
</script>
</body>
</html>
